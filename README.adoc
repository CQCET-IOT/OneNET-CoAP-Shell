= CoAP Shell

https://bintray.com/big-data/maven/coap-shell/_latestVersion[ image:https://api.bintray.com/packages/big-data/maven/coap-shell/images/download.svg[Download] ]

https://en.wikipedia.org/wiki/Constrained_Application_Protocol[CoAP] is a RESTful web transfer protocol specialized for use with constrained nodes and constrained networks in the Internet of Things (IoT).

The `CoAP Shell` is an interactive, command line interface for interacting with CoAP Server. Supports both `coap:` and `coaps:` schemas (e.g. UDP and (https://en.wikipedia.org/wiki/Datagram_Transport_Layer_Security[DTLS]).
(The Shell can be used to explore the `IKEA TRÅDFRI Gateway` as well).

The CoAP Shell is build on top of the https://projects.spring.io/spring-shell/[Spring Shell], https://www.eclipse.org/californium/[Californium (Cf)] and https://www.eclipse.org/californium/[Scandium (Sc)]
projects. It is a https://spring.io/projects/spring-boot[SpringBoot] application, that builds into a single, self-executable jar and runs on any Java8+ environment.

image:https://raw.githubusercontent.com/tzolov/coap-shell/master/src/test/resources/coap-shell-demo2.gif[CoAP Shell Demo]

=== Features
* Plain https://tools.ietf.org/html/rfc7252#section-6.1[coap:] and secured https://tools.ietf.org/html/rfc7252#section-6.2[coaps:] endpoints (e.g. `UDP` and `DTLS` transports).
* CoAP `get`, `put`, `post` and `delete` methods.
* `Synchronous` and `Asynchronous` (`--async` argument) message exchanges.
* CoAP https://tools.ietf.org/html/rfc7641[Observing].
* https://tools.ietf.org/html/draft-ietf-core-observe-08#section-3.5[Confirmable] and `Non-Confirmable` message exchange.
* CoAP https://tools.ietf.org/html/rfc7252#section-7.2[Discovery]. Filter by `href`, `ct`, `rt`, `obs` ...
* TAB auto-completion for `command` and `argument` auto-completion.
* Intuitive command help support (type `help`).
* Alternative Key/Trust Stores can be plugged in.
* Single, self-executable (`SpringBoot`) jar, working on any JKD8+ environment.
* Basic support for `IKEA Tradfri Gateway`.

The https://youtu.be/zhEGFfCJwTg[CoAP Shell video] below, highlights some of the features provided by the shell:

https://youtu.be/zhEGFfCJwTg[image:https://raw.githubusercontent.com/tzolov/coap-shell/master/src/test/resources/coap-shell-video-log.png[CoAP Shell video]]

=== Quick Start

* Get a pre-build https://bintray.com/big-data/maven/download_file?file_path=io%2Fdatalake%2Fcoap%2Fcoap-shell%2F1.0.2%2Fcoap-shell-1.0.2.jar[coap-shell.jar] or build one yourself following the instructions further down.
* Then start the shell like this
[source,bash]
----
java -jar ./coap-shell-1.0.2.jar
----

[source,bash]
----
  _____     ___   ___     ______       ____
 / ___/__  / _ | / _ \   / __/ /  ___ / / /
/ /__/ _ \/ __ |/ ___/  _\ \/ _ \/ -_) / /
\___/\___/_/ |_/_/     /___/_//_/\__/_/_/
CoAP Shell (v1.0.2)
For assistance hit TAB or type "help".

server-unknown:>
----

* Connect to CoAP server (such as `coaps://californium.eclipse.org:5684` or `coap://coap.me`)
[source,bash]
----
server-unknown:>connect coaps://californium.eclipse.org:5684
available
coaps://californium.eclipse.org:5684:>
----

* Discover the available CoAP resources:
[source,bash]
----
coaps://californium.eclipse.org:5684:>discover --query href=/*
┌─────────────────┬───────────────────┬────────────────────────────────────┬───────────────┬──────────────────┬────────────────┐
│Path (href)      │Resource Types (rt)│Content Types (ct)                  │Interfaces (if)│Size estimate (sz)│Observable (obs)│
├─────────────────┼───────────────────┼────────────────────────────────────┼───────────────┼──────────────────┼────────────────┤
│/large           │block              │                                    │               │1280              │                │
├─────────────────┼───────────────────┼────────────────────────────────────┼───────────────┼──────────────────┼────────────────┤
│/multi-format    │                   │text/plain (0), application/xml (41)│               │                  │                │
├─────────────────┼───────────────────┼────────────────────────────────────┼───────────────┼──────────────────┼────────────────┤
                                                        .....
----

* Get resource data
[source,bash]
----
coaps://californium.eclipse.org:5684:>get /multi-format --accept application/xml
CoAP GET: coaps://californium.eclipse.org:5684/multi-format
-------------------------------- CoAP Response ---------------------------------
 MID    : 53611
 Token  : [c64e9a0af487b20d]
 Type   : ACK
 Status : 205-Reset Content
 Options: {"Content-Format":"application/xml"}
 RTT    : 124 ms
 Payload: 63 Bytes
............................... Body Payload ...................................
<msg type="CON" code="GET" mid=53611 accept="application/xml"/>
--------------------------------------------------------------------------------

----

* Use `help` to the available commands and how are they used.
* Use `TAB` for command and argument auto-completion.

=== IKEA TRÅDFRI Gateway Support

* Generate Gateway pre-share key
Use the `ikea gateway key` to register a new account (e.g. identity + secret) to your IKEA Gateway:

[source,bash]
----
server-unknown:>ikea gateway key --ip 192.168.178.151 --identity myIkeaGatewayIdentity --security-code <Gateway Code Label>
-------------------------------- CoAP Response ---------------------------------
 MID    : 58318
 Token  : [60d1dcf80d8eb84f]
 Type   : ACK
 Status : 201-Created
 Options: {}
 RTT    : 371 ms
 Payload: 45 Bytes
............................... Body Payload ...................................
{"9091":"X5xyYM41qFS7vNa9","9029":"1.3.0014"}
--------------------------------------------------------------------------------
IDENTITY: myIkeaGatewayIdentity , PRE_SHARED_KEY: X5xyYM41qFS7vN10
----

The `192.168.178.151` is the IP address of the gateway in your network. Please find your gateway's IP and use it instead!
The `myIkeaGatewayIdentity` is the new identity to be registered with the gateway. the `<Gateway Code Label>` is printed on the back side of the Gateway box.
The response `IDENTITY: myIkeaGatewayIdentity , PRE_SHARED_KEY: X5xyYM41qFS7vNa9` will contain the new credential created for you. Store the generated identity and secret so you cna use them to connect interact with your IKEA gateway.

* Use the generated credentials to connect to gateway

[source,bash]
----
server-unknown:>connect coaps://192.168.178.151:5684 --identity myIkeaGatewayIdentity --secret X5xyYM41qFS7vN10
available
coaps://192.168.178.151:5684:>
----

* List available devices

[source,bash]
----
coaps://192.168.178.151:5684:>ikea devices
┌────────┬─────────┬──────┬───────────────────────────────┬────────┬───────────┬──────┐
│Instance│Name     │Type  │Model                          │Firmware│Battery [%]│ON/OFF│
├────────┼─────────┼──────┼───────────────────────────────┼────────┼───────────┼──────┤
│65537   │E27 LR4  │LIGHT │TRADFRI bulb E27 CWS opal 600lm│1.3.002 │-          │OFF   │
├────────┼─────────┼──────┼───────────────────────────────┼────────┼───────────┼──────┤
│65536   │Remote LR│SWITCH│TRADFRI remote control         │1.2.214 │87         │-     │
├────────┼─────────┼──────┼───────────────────────────────┼────────┼───────────┼──────┤
│65541   │GU10 LR2 │LIGHT │TRADFRI bulb GU10 WS 400lm     │1.2.217 │-          │OFF   │
├────────┼─────────┼──────┼───────────────────────────────┼────────┼───────────┼──────┤
│65538   │Sensor WC│SENSOR│TRADFRI motion sensor          │1.2.214 │100        │-     │
└────────┴─────────┴──────┴───────────────────────────────┴────────┴───────────┴──────┘
----

* Turn on and off a lamp

[source,bash]
----
coaps://192.168.178.151:5684:>ikea turn on --instance 65539
OK

coaps://192.168.178.151:5684:>ikea devices
┌────────┬─────────┬──────┬───────────────────────────────┬────────┬───────────┬──────┐
│Instance│Name     │Type  │Model                          │Firmware│Battery [%]│ON/OFF│
├────────┼─────────┼──────┼───────────────────────────────┼────────┼───────────┼──────┤
│65539   │GU10 WC  │LIGHT │TRADFRI bulb GU10 W 400lm      │1.2.214 │-          │ON    │
├────────┼─────────┼──────┼───────────────────────────────┼────────┼───────────┼──────┤

coaps://192.168.178.151:5684:>ikea turn off --instance 65539
OK

coaps://192.168.178.151:5684:>ikea devices
┌────────┬─────────┬──────┬───────────────────────────────┬────────┬───────────┬──────┐
│Instance│Name     │Type  │Model                          │Firmware│Battery [%]│ON/OFF│
├────────┼─────────┼──────┼───────────────────────────────┼────────┼───────────┼──────┤
│65539   │GU10 WC  │LIGHT │TRADFRI bulb GU10 W 400lm      │1.2.214 │-          │OFF   │
├────────┼─────────┼──────┼───────────────────────────────┼────────┼───────────┼──────┤
----

* Use the CoAP GET check the raw message response

[source,bash]
----
coaps://192.168.178.151:5684:>get //15001/65539
CoAP GET: coaps://192.168.178.151:5684//15001/65539
-------------------------------- CoAP Response ---------------------------------
 MID    : 57799
 Token  : [5037c0b052a0d656]
 Type   : ACK
 Status : 205-Reset Content
 Options: {"Content-Format":"application/json", "Max-Age":604800}
 RTT    : 7 ms
 Payload: 220 Bytes
............................... Body Payload ...................................
{
  "3311" : [ {
    "5850" : 1,
    "5851" : 203,
    "9003" : 0
  } ],
  "9001" : "GU10 WC",
  "9002" : 1528124737,
  "9020" : 1528374678,
  "9003" : 65539,
  "9054" : 0,
  "5750" : 2,
  "9019" : 1,
  "3" : {
    "0" : "IKEA of Sweden",
    "1" : "TRADFRI bulb GU10 W 400lm",
    "2" : "",
    "3" : "1.2.214",
    "6" : 1
  }
}
--------------------------------------------------------------------------------

----

=== How to Build

Clone the project from GitHub and build with Maven.

[source,bash]
----
git clone https://github.com/tzolov/coap-shell.git
cd ./coap-shell
./mvnw clean install
----

Then run the self-executable jar in the `target` folder.

=== Debugging

Start the shell with `--logging.level=DEBUG` to enable debug log level for the entire applicationor `--logging.level.org.eclipse.californium=DEBUG`
to debug only californium and scandium. Later is useful to debug the CoAP request message and DTLS interactions.

For example:
[source,bash]
----
java -jar ./target/coap-shell-1.0.3-SNAPSHOT.jar --logging.level.org.eclipse.californium=DEBUG
----
